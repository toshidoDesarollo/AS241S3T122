<mat-card>
  <mat-card-header style="display: flex; align-items: center;">
    <mat-card-title>Lista de √ìrdenes</mat-card-title>
    <span class="spacer"></span>
    <button mat-raised-button color="primary" (click)="createNewOrder()">
      <mat-icon>add</mat-icon> Nueva Orden
    </button>
  </mat-card-header>
  
  <!-- ========== SECCI√ìN DE FILTROS ========== -->
  <mat-card-content>
    <div class="filters-container">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>üîç Buscar por ID</mat-label>
        <input matInput type="number" [(ngModel)]="filterId" (keyup)="applyFilters()" placeholder="Ej: 1">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>üìÖ Buscar por Fecha</mat-label>
        <input matInput [matDatepicker]="picker" [(ngModel)]="filterDate" (dateChange)="applyFilters()">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>üìç Buscar por Direcci√≥n</mat-label>
        <input matInput [(ngModel)]="filterAddress" (keyup)="applyFilters()" placeholder="Ej: Av. Principal">
        <mat-icon matSuffix>location_on</mat-icon>
      </mat-form-field>

      <button mat-raised-button color="warn" (click)="clearFilters()" class="clear-button">
        <mat-icon>clear</mat-icon> Limpiar
      </button>
    </div>

    <mat-tab-group (selectedTabChange)="onTabChange($event)">
      
      <!-- ================= TAB 1: PENDIENTE ================= -->
      <mat-tab label="‚è≥ En Proceso">
        <ng-template matTabContent>
          <div class="mat-elevation-z8 table-container">
            
            <!-- VISTA DESKTOP -->
            <div class="desktop-view">
              <table mat-table [dataSource]="dataSourcePending" class="full-width-table" matSort #sortPending="matSort">
                
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                  <td mat-cell *matCellDef="let order"> {{ order.id }} </td>
                </ng-container>

                <ng-container matColumnDef="orderDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> F. Orden </th>
                  <td mat-cell *matCellDef="let order"> 
                    <!--  PIPE NATIVO: date - Formatea fecha en formato dd/MM/yyyy -->
                    {{ order.orderDate | date:'dd/MM/yyyy' }} 
                  </td>
                </ng-container>

                <ng-container matColumnDef="deliveryDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> F. Entrega </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE NATIVO: date - Formatea fecha de entrega -->
                    <div>{{ order.deliveryDate | date:'dd/MM/yyyy' }}</div>
                    <!--  PIPE PERSONALIZADO: diasHastaEntrega - Calcula d√≠as restantes -->
                    <small style="color: #666;">{{ order.deliveryDate | diasHastaEntrega }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="deliveryAddress">
                  <th mat-header-cell *matHeaderCellDef> Direcci√≥n </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: resumenDireccion - Trunca direcciones largas a 30 caracteres -->
                    {{ order.deliveryAddress | resumenDireccion:30 }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="paymentMethod">
                  <th mat-header-cell *matHeaderCellDef> Pago </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: metodoPago - Agrega emoji seg√∫n m√©todo de pago -->
                    {{ order.paymentMethod | metodoPago }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="notes">
                  <th mat-header-cell *matHeaderCellDef> Notas </th>
                  <td mat-cell *matCellDef="let order"> {{ order.notes || 'Sin notas' }} </td>
                </ng-container>

                <ng-container matColumnDef="totalAmount">
                  <th mat-header-cell *matHeaderCellDef> Total </th>
                  <td mat-cell *matCellDef="let order">
                    <!-- PIPE NATIVO: currency - Formatea como moneda USD con s√≠mbolo $ y 2 decimales -->
                    {{ order.totalAmount | currency:'USD':'symbol':'1.2-2' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
                  <td mat-cell *matCellDef="let order">
                    <span class="estado-badge pendiente">
                      <!--  PIPE PERSONALIZADO: estadoOrden - Convierte c√≥digo a texto con emoji -->
                      {{ order.status | estadoOrden }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef> Acciones </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button [matMenuTriggerFor]="menuPending" matTooltip="M√°s opciones">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menuPending="matMenu">
                      <button mat-menu-item (click)="editOrder(order)">
                        <mat-icon color="primary">edit</mat-icon>
                        <span>Editar</span>
                      </button>
                      <mat-divider></mat-divider>
                      <button mat-menu-item (click)="changeOrderStatus(order.id, order.status, 'E')">
                        <mat-icon style="color: #38a169;">check_circle</mat-icon>
                        <span>Marcar como Entregado</span>
                      </button>
                      <button mat-menu-item (click)="changeOrderStatus(order.id, order.status, 'C')">
                        <mat-icon style="color: #e53e3e;">cancel</mat-icon>
                        <span>Cancelar Orden</span>
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef> Detalles </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="accent" (click)="viewDetails(order)" matTooltip="Ver Detalles">
                      <mat-icon>list_alt</mat-icon>
                    </button>
                    <!--  PIPE PERSONALIZADO: cantidadProductos - Cuenta productos en la orden -->
                    <small style="display: block; color: #666;">{{ order | cantidadProductos }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="report">
                  <th mat-header-cell *matHeaderCellDef> Reporte </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="basic" (click)="generateReport(order.id)" matTooltip="Generar PDF">
                      <mat-icon>picture_as_pdf</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
              <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons #paginatorPending></mat-paginator>
              <div *ngIf="dataSourcePending.data.length === 0" style="padding: 20px; text-align: center">
                No hay √≥rdenes en proceso disponibles.
              </div>
            </div>

            <!-- VISTA M√ìVIL -->
            <div class="mobile-view">
              <div class="order-card" *ngFor="let order of dataSourcePending.data">
                <div class="card-header">
                  <span class="order-id">Orden #{{ order.id }}</span>
                  <!--  PIPE PERSONALIZADO: estadoOrden -->
                  <span class="order-status pendiente">{{ order.status | estadoOrden }}</span>
                </div>
                <div class="card-body">
                  <div class="info-item">
                    <span class="info-label">F. Orden:</span>
                    <!--  PIPE NATIVO: date -->
                    <span class="info-value">{{ order.orderDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">F. Entrega:</span>
                    <!--  PIPE PERSONALIZADO: diasHastaEntrega -->
                    <span class="info-value">{{ order.deliveryDate | diasHastaEntrega }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Total:</span>
                    <!--  PIPE NATIVO: currency -->
                    <span class="info-value">{{ order.totalAmount | currency:'USD':'symbol':'1.2-2' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Prioridad:</span>
                    <!--  PIPE PERSONALIZADO: prioridadOrden - Calcula prioridad seg√∫n fecha y estado -->
                    <span class="info-value">{{ order.deliveryDate | prioridadOrden:order.status }}</span>
                  </div>
                </div>
                <div class="card-actions">
                  <button mat-button (click)="editOrder(order)">
                    <mat-icon>edit</mat-icon> Editar
                  </button>
                  <button mat-button (click)="changeOrderStatus(order.id, order.status, 'E')">
                    <mat-icon>check</mat-icon> Entregar
                  </button>
                  <button mat-button (click)="changeOrderStatus(order.id, order.status, 'C')">
                    <mat-icon>cancel</mat-icon> Cancelar
                  </button>
                  <button mat-button color="accent" (click)="viewDetails(order)">
                    <mat-icon>list_alt</mat-icon> Detalles
                  </button>
                </div>
              </div>
              <div *ngIf="dataSourcePending.data.length === 0" style="padding: 20px; text-align: center">
                No hay √≥rdenes en proceso disponibles.
              </div>
            </div>
          </div>
        </ng-template>
      </mat-tab>

      <!-- ================= TAB 2: ENTREGADO ================= -->
      <mat-tab label="‚úÖ Entregado">
        <ng-template matTabContent>
          <div class="mat-elevation-z8 table-container">
            <div class="desktop-view">
              <table mat-table [dataSource]="dataSourceCompleted" class="full-width-table" matSort #sortCompleted="matSort">
                
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                  <td mat-cell *matCellDef="let order"> {{ order.id }} </td>
                </ng-container>

                <ng-container matColumnDef="orderDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> F. Orden </th>
                  <td mat-cell *matCellDef="let order"> 
                    <!--  PIPE NATIVO: date -->
                    {{ order.orderDate | date:'dd/MM/yyyy' }} 
                  </td>
                </ng-container>

                <ng-container matColumnDef="deliveryDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> F. Entrega </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE NATIVO: date -->
                    <div>{{ order.deliveryDate | date:'dd/MM/yyyy' }}</div>
                    <!--  PIPE PERSONALIZADO: diasHastaEntrega -->
                    <small style="color: #666;">{{ order.deliveryDate | diasHastaEntrega }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="deliveryAddress">
                  <th mat-header-cell *matHeaderCellDef> Direcci√≥n </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: resumenDireccion -->
                    {{ order.deliveryAddress | resumenDireccion:30 }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="paymentMethod">
                  <th mat-header-cell *matHeaderCellDef> Pago </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: metodoPago -->
                    {{ order.paymentMethod | metodoPago }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="notes">
                  <th mat-header-cell *matHeaderCellDef> Notas </th>
                  <td mat-cell *matCellDef="let order"> {{ order.notes || 'Sin notas' }} </td>
                </ng-container>

                <ng-container matColumnDef="totalAmount">
                  <th mat-header-cell *matHeaderCellDef> Total </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE NATIVO: currency -->
                    {{ order.totalAmount | currency:'USD':'symbol':'1.2-2' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: estadoOrden -->
                    <span class="estado-badge entregado">{{ order.status | estadoOrden }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef> Acciones </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button [matMenuTriggerFor]="menuCompleted" matTooltip="M√°s opciones">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menuCompleted="matMenu">
                      <button mat-menu-item (click)="changeOrderStatus(order.id, order.status, 'P')">
                        <mat-icon style="color: #fbbd23;">restore</mat-icon>
                        <span>Volver a Pendiente</span>
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef> Detalles </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="accent" (click)="viewDetails(order)" matTooltip="Ver Detalles">
                      <mat-icon>list_alt</mat-icon>
                    </button>
                    <!--  PIPE PERSONALIZADO: cantidadProductos -->
                    <small style="display: block; color: #666;">{{ order | cantidadProductos }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="report">
                  <th mat-header-cell *matHeaderCellDef> Reporte </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="basic" (click)="generateReport(order.id)" matTooltip="Generar PDF">
                      <mat-icon>picture_as_pdf</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
              <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons #paginatorCompleted></mat-paginator>
              <div *ngIf="dataSourceCompleted.data.length === 0" style="padding: 20px; text-align: center">
                No hay √≥rdenes completadas disponibles.
              </div>
            </div>

            <!-- VISTA M√ìVIL -->
            <div class="mobile-view">
              <div class="order-card" *ngFor="let order of dataSourceCompleted.data">
                <div class="card-header">
                  <span class="order-id">Orden #{{ order.id }}</span>
                  <!--  PIPE PERSONALIZADO: estadoOrden -->
                  <span class="order-status entregado">{{ order.status | estadoOrden }}</span>
                </div>
                <div class="card-body">
                  <div class="info-item">
                    <span class="info-label">F. Orden:</span>
                    <!--  PIPE NATIVO: date -->
                    <span class="info-value">{{ order.orderDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">F. Entrega:</span>
                    <!--  PIPE PERSONALIZADO: diasHastaEntrega -->
                    <span class="info-value">{{ order.deliveryDate | diasHastaEntrega }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Total:</span>
                    <!--  PIPE NATIVO: currency -->
                    <span class="info-value">{{ order.totalAmount | currency:'USD':'symbol':'1.2-2' }}</span>
                  </div>
                </div>
                <div class="card-actions">
                  <button mat-button (click)="changeOrderStatus(order.id, order.status, 'P')">
                    <mat-icon>restore</mat-icon> Restaurar
                  </button>
                  <button mat-button color="accent" (click)="viewDetails(order)">
                    <mat-icon>list_alt</mat-icon> Detalles
                  </button>
                </div>
              </div>
              <div *ngIf="dataSourceCompleted.data.length === 0" style="padding: 20px; text-align: center">
                No hay √≥rdenes completadas disponibles.
              </div>
            </div>
          </div>
        </ng-template>
      </mat-tab>

      <!-- ================= TAB 3: CANCELADO ================= -->
      <mat-tab label="‚ùå Cancelado">
        <ng-template matTabContent>
          <div class="mat-elevation-z8 table-container">
            <div class="desktop-view">
              <table mat-table [dataSource]="dataSourceCancelled" class="full-width-table" matSort #sortCancelled="matSort">
                
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                  <td mat-cell *matCellDef="let order"> {{ order.id }} </td>
                </ng-container>

                <ng-container matColumnDef="orderDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> F. Orden </th>
                  <td mat-cell *matCellDef="let order"> 
                    <!--  PIPE NATIVO: date -->
                    {{ order.orderDate | date:'dd/MM/yyyy' }} 
                  </td>
                </ng-container>

                <ng-container matColumnDef="deliveryDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> F. Entrega </th>
                  <td mat-cell *matCellDef="let order">
                   <!--  PIPE NATIVO: date -->
                   <div>{{ order.deliveryDate | date:'dd/MM/yyyy' }}</div>
                   <!--  PIPE PERSONALIZADO: diasHastaEntrega -->
                    <small style="color: #666;">{{ order.deliveryDate | diasHastaEntrega }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="deliveryAddress">
                  <th mat-header-cell *matHeaderCellDef> Direcci√≥n </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: resumenDireccion -->
                    {{ order.deliveryAddress | resumenDireccion:30 }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="paymentMethod">
                  <th mat-header-cell *matHeaderCellDef> Pago </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: metodoPago -->
                    {{ order.paymentMethod | metodoPago }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="notes">
                  <th mat-header-cell *matHeaderCellDef> Notas </th>
                  <td mat-cell *matCellDef="let order"> {{ order.notes || 'Sin notas' }} </td>
                </ng-container>

                <ng-container matColumnDef="totalAmount">
                  <th mat-header-cell *matHeaderCellDef> Total </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE NATIVO: currency -->
                    {{ order.totalAmount | currency:'USD':'symbol':'1.2-2' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
                  <td mat-cell *matCellDef="let order">
                    <!--  PIPE PERSONALIZADO: estadoOrden -->
                    <span class="estado-badge cancelado">{{ order.status | estadoOrden }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef> Acciones </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button [matMenuTriggerFor]="menuCancelled" matTooltip="M√°s opciones">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menuCancelled="matMenu">
                      <button mat-menu-item (click)="changeOrderStatus(order.id, order.status, 'P')">
                        <mat-icon style="color: #fbbd23;">restore</mat-icon>
                        <span>Restaurar a Pendiente</span>
                      </button>
                      <button mat-menu-item (click)="changeOrderStatus(order.id, order.status, 'E')">
                        <mat-icon style="color: #38a169;">check_circle</mat-icon>
                        <span>Marcar como Entregado</span>
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef> Detalles </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="accent" (click)="viewDetails(order)" matTooltip="Ver Detalles">
                      <mat-icon>list_alt</mat-icon>
                    </button>
                    <!--  PIPE PERSONALIZADO: cantidadProductos -->
                    <small style="display: block; color: #666;">{{ order | cantidadProductos }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="report">
                  <th mat-header-cell *matHeaderCellDef> Reporte </th>
                  <td mat-cell *matCellDef="let order">
                    <button mat-icon-button color="basic" (click)="generateReport(order.id)" matTooltip="Generar PDF">
                      <mat-icon>picture_as_pdf</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
              <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons #paginatorCancelled></mat-paginator>
              <div *ngIf="dataSourceCancelled.data.length === 0" style="padding: 20px; text-align: center">
                No hay √≥rdenes canceladas disponibles.
              </div>
            </div>

            <!-- VISTA M√ìVIL -->
            <div class="mobile-view">
              <div class="order-card" *ngFor="let order of dataSourceCancelled.data">
                <div class="card-header">
                  <span class="order-id">Orden #{{ order.id }}</span>
                  <!--  PIPE PERSONALIZADO: estadoOrden -->
                  <span class="order-status cancelado">{{ order.status | estadoOrden }}</span>
                </div>
                <div class="card-body">
                  <div class="info-item">
                    <span class="info-label">F. Orden:</span>
                    <!--  PIPE NATIVO: date -->
                    <span class="info-value">{{ order.orderDate | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">F. Entrega:</span>
                    <!--  PIPE PERSONALIZADO: diasHastaEntrega -->
                    <span class="info-value">{{ order.deliveryDate | diasHastaEntrega }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Total:</span>
                    <!--  PIPE NATIVO: currency -->
                    <span class="info-value">{{ order.totalAmount | currency:'USD':'symbol':'1.2-2' }}</span>
                  </div>
                </div>
                <div class="card-actions">
                  <button mat-button (click)="changeOrderStatus(order.id, order.status, 'P')">
                    <mat-icon>restore</mat-icon> Restaurar
                  </button>
                  <button mat-button (click)="changeOrderStatus(order.id, order.status, 'E')">
                    <mat-icon>check</mat-icon> Entregar
                  </button>
                  <button mat-button color="accent" (click)="viewDetails(order)">
                    <mat-icon>list_alt</mat-icon> Detalles
                  </button>
                </div>
              </div>
              <div *ngIf="dataSourceCancelled.data.length === 0" style="padding: 20px; text-align: center">
                No hay √≥rdenes canceladas disponibles.
              </div>
            </div>
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </mat-card-content>
</mat-card>